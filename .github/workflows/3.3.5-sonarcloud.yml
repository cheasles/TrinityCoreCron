name: 3.3.5 SonarCloud

on: 
  workflow_dispatch:
    inputs:
  push:
    branches:
      - 3.3.5-SonarCloud

env:
  SONAR_SCANNER_VERSION: 4.4.0.2170
  SONAR_SCANNER_OPTS: -server

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      with:
        repository: jackpoz/TrinityCore
        ref: 3.3.5
        fetch-depth: 0
    - name: Dependencies
      run: |
        sudo apt-get update && sudo apt-get install -yq libboost-all-dev
    - name: SonarCloud Setup
      run: |
        curl --create-dirs -sSLo $HOME/.sonar/build-wrapper-linux-x86.zip https://sonarcloud.io/static/cpp/build-wrapper-linux-x86.zip
        unzip -o $HOME/.sonar/build-wrapper-linux-x86.zip -d $HOME/.sonar/
        echo "::add-path::$HOME/.sonar/build-wrapper-linux-x86"
        curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip 
        unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
        echo "::add-path::$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux/bin"
    - name: Setup
      run: |
        mkdir bin
        cd bin
        cmake ../ -DWITH_WARNINGS=1 -DWITH_COREDEBUG=0 -DUSE_COREPCH=0 -DUSE_SCRIPTPCH=0 -DTOOLS=1 -DSCRIPTS=dynamic -DSERVERS=0 -DNOJEM=0 -DCMAKE_BUILD_TYPE=Debug -DCMAKE_C_FLAGS_DEBUG="-DNDEBUG" -DCMAKE_CXX_FLAGS_DEBUG="-DNDEBUG" -DCMAKE_INSTALL_PREFIX=check_install -DBUILD_TESTING=0
    - name: Build
      run: |
        cd bin
        build-wrapper-linux-x86-64 --out-dir bw-output make -j 4 -k && make install
    - name: SonarCloud Analysis
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        sonar-scanner \
          -Dsonar.organization=jackpoz-github \
          -Dsonar.projectKey=jackpoz_TrinityCore \
          -Dsonar.sources=src \
          -Dsonar.cfamily.build-wrapper-output=bin/bw-output \
          -Dsonar.host.url=https://sonarcloud.io